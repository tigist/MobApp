<!DOCTYPE HTML>
<html>
<head>
<title>BRIDGE Mob agent demo</title>
<script type="text/javascript" charset="utf-8" src="js/jquery-1.7.2.min.js"></script>
<script type="text/javascript" charset="utf-8" src="js/jquery.rest.min.js"></script>
<script type="text/javascript" charset="utf-8" src="js/jquery.json-2.3.min.js"></script>
<script type="text/javascript" charset="utf-8" >

var my_renderer = function(json,olddata , cache) {  
        if(json && json != "") {
            console.log("running! "); 
            console.log(JSON.stringify(json));
           
            var info3 = json;
            var tmp='';
            for (var i=0; i<info3.length; i++){
           	 tmp+="lat = "+ info3[i].lat+'<br>'
            	    +"lon = "+ info3[i].lon +'<br>'
            	    +"name = "+ info3[i].name +'<br>'
             	    +"uuid = "+ info3[i].uuid +'<hr>';
            		document.getElementById('cache-data').innerHTML=tmp; 
            }
  	}
}

var my_renderer1 = function(json, olddata , cache){
		 if(json && json != "") {
			console.log("running my_reneder1! "); 
	        console.log(JSON.stringify(json));
	        var info3 = json;
	        var tmp='';
	        if (document.getElementById('search').value!=null){
	        	var nameValue = document.getElementById('search').value
	       		 for (var i=0; i<info3.length; i++){	      
	         	    var lon = info3[i].lon;
	         	    var lat = info3[i].lat;
	         	    var name = info3[i].name;
	         	    var uuidValue = info3[i].uuid
	         	    if (info3[i].name == nameValue){//similarity maching for string name can be modified
	        			document.getElementById('lon').value=lon; 
	        			document.getElementById('lat').value=lat; 
	        			document.getElementById('name').value=name; 
	        			document.getElementById('uuid').value=uuidValue;
	        			}
	         	   }
	       		 }else{
	       			 alert("search agent by name before you update");
	       		 }
	        
	        }
		 }

update = function(){
   			var divValues = $('input[type=text]');
    		var obj = {};
    		$.map(divValues, function(n, i) {
        		obj[n.name] = $(n).val();
   			 });

    		alert(JSON.stringify(obj));
   			var uuid = document.getElementById('uuid').value;
   				if (uuid == null){alert("you can update existining agent only")};
   				alert(uuid);
				var url = "http://memo-app-services.appspot.com/agent/" + uuid;
				var data = obj; //{"lat":"0","lon":"0","name":"assistant-modified"};

 				$.ajax({
					 type: "PUT",
   					 xhrFields:{
        				withCredentials:true  
    				},
    				contentType:"application/json; charset=utf-8",
    				data: JSON.stringify(data), 
    				url: url,
   					success: function(msg){ console.log("agent " +  msg + "updated"); },
   					error: function(a,b,c) {
      					 console.log("XMLHttpRequest: " + a);
       					 console.log("textStatus: " + b);
       					 console.log("errorThrown: " + c);
       					 } 
   					});
 				}


</script>
<script type="text/javascript" charset="utf-8" src="js/askREST_cache.js"></script>
<script type="text/javascript" src="js/angular-1.0.0rc9.min.js"></script>

</head>
<body >

<script type="text/javascript">
doPost = function (){
    			cache.post();
			}

var setupCache = function() {  
					     if(!caches.exists("label")) {
                    	 console.log("Init Cache");
                         cache = new ASKCache("label","agent/",null,"uuid",session,true);
                         cache.addRenderer('all', my_renderer);
                         cache.onChangeCBs[cache.onChangeCBs.length]=function(a,b){console.log(a,b);};
                         cache.render(); 
                         alert("new cache created");
                     }else{
                     	alert("cache already exist");
						
                     }                       
          		} 
var setupCache1 = function() {  
    				if(!caches.exists("label")) {
	 					console.log("Init Cache");
    					cache = new ASKCache("label","agent/",null,"uuid",session,true);
   						cache.addRenderer('all', my_renderer);
   						cache.onChangeCBs[cache.onChangeCBs.length]=function(a,b){console.log(a,b);};
    					cache.render(); 
   						alert("new cache created");
					}else{
						alert("cache already exist continoue to update");
						cache.addRenderer('all', my_renderer1);
						}
    				}
</script>

<h4>Mobile agent, test 3</h4>
	<button id= "start" onclick="setupCache();"> start </button>
	<button id = "Postbtn" onclick="doPost();">Create agent</button>
	<button id= "start" onclick="setupCache1();"> starter </button>	
	<button id = "update" onclick="update();">update agent</button><br>
	search agent by name: <input name ="search" id="search" >
	

	<div id="ele" name ="ele" style=" border: black 2px dashed; width:350px;" >
		lon: <input type= "text" id="lon" name="lon" /><br>
		lat:<input type= "text" id="lat" name = "lat"/><br>
		name<input type= "text" id="name" name="name"/><br>
	</div><br />
	
	<div id="cache-data" style="width:400px;float:left;"></div><br />	
	
	<input type="hidden" name ="uuid" id="uuid" ><br>
	
	<form>
		<input type="button" value ="Reload Page" onClick="history.go(0)">
	</form>
</body>
</html>
